name: Build and Cache Ubuntu VM

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 1'  # Runs every Monday at midnight
  pull_request:
    branches:
      - main

env:
  DEBIAN_FRONTEND: noninteractive
  VM_NAME_BASE: e2e-runner
  ARTIFACTS_DIR: /tmp/e2e-artifacts

jobs:
  provision-vm:
    name: Provision and cache Ubuntu VM for the E2E tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    strategy:
      matrix:
        release: [noble, questing]
      fail-fast: false
    steps:
      - name: Restore cached VM image (if available)
        id: restore-cache
        uses: actions/cache/restore@v4
        with:
            path: ${{ env.ARTIFACTS_DIR }}/${{ env.VM_NAME_BASE }}-${{ matrix.release }}.qcow2
            key: e2e-runner-${{ matrix.release }}
            fail-on-cache-miss: false

      - name: Checkout repo
        if: steps.restore-cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4

      - uses: canonical/desktop-engineering/gh-actions/common/dpkg-install-speedup@main
        if: steps.restore-cache.outputs.cache-hit != 'true'

      - name: Install APT dependencies for VM provisioning
        if: steps.restore-cache.outputs.cache-hit != 'true'
        run: ./e2e-tests/vm/install-provision-deps.sh

      - name: Set up SSH keys for the VM provisioning
        if: steps.restore-cache.outputs.cache-hit != 'true'
        uses: ./.github/actions/e2e-tests/set-up-ssh-keys
        with:
          E2E_VM_SSH_PRIV_KEY: ${{ secrets.E2E_VM_SSH_PRIV_KEY }}
          E2E_VM_SSH_PUB_KEY: ${{ secrets.E2E_VM_SSH_PUB_KEY }}

      - name: Provision the base E2E Ubuntu VM
        id: provision-vm
        if: steps.restore-cache.outputs.cache-hit != 'true'
        run: |
          set -eu

          # Set up temporary directory for VM artifacts
          mkdir -p ${{ env.ARTIFACTS_DIR }}

          env VM_NAME_BASE="${{ env.VM_NAME_BASE }}" \
            RELEASE="${{ matrix.release }}" \
            ARTIFACTS_DIR="${{ env.ARTIFACTS_DIR }}" \
            SSH_PUBLIC_KEY_FILE=/home/runner/.ssh/id_rsa.pub \
            ./e2e-tests/vm/provision-ubuntu.sh

      - name: Clean previous cache
        if: always() && steps.provision-vm.outcome == 'success'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -eu
          gh cache delete e2e-runner-${{ matrix.release }} || true
          echo "Previous cache (if any) deleted"

      - name: Cache the VM image
        uses: actions/cache/save@v4
        if: always() && steps.provision-vm.outcome == 'success'
        with:
          path: ${{ env.ARTIFACTS_DIR }}/${{ env.VM_NAME_BASE }}-${{ matrix.release }}.qcow2
          key: e2e-runner-${{ matrix.release }}

      - name: Upload cache as artifact
        if: steps.provision-vm.outcome == 'success' || steps.restore-cache.outputs.cache-hit == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: e2e-runner-${{ matrix.release }}
          path: ${{ env.ARTIFACTS_DIR }}/${{ env.VM_NAME_BASE }}-${{ matrix.release }}.qcow2
